<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amy and the Treasure Map â€” è‹±èªæ•…äº‹å­¸ç¿’</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{
  --sky:#5BC8F5; --sun:#FFD93D; --grass:#6BCB77; --coral:#FF6B6B;
  --lavender:#C3A6FF; --peach:#FFB347; --ink:#2D3047; --card:#FFFDF5;
  --shadow:0 4px 20px rgba(45,48,71,.10); --r:20px; --hl:#FFE566; --hlw:#B5F2FF;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Nunito',sans-serif;background:linear-gradient(160deg,#e0f7fa,#fff9e6 50%,#fce4f0);min-height:100vh;color:var(--ink);padding-bottom:60px}

header{background:linear-gradient(135deg,var(--sky),var(--lavender));padding:26px 20px 20px;text-align:center;box-shadow:0 6px 24px rgba(91,200,245,.35)}
header h1{font-family:'Baloo 2',cursive;font-size:clamp(1.4rem,5vw,2.4rem);color:#fff;text-shadow:3px 3px 0 rgba(0,0,0,.15);line-height:1.25}
header p{color:rgba(255,255,255,.9);font-size:.92rem;margin-top:6px;font-weight:700}

.speed-bar{background:#fff;border-radius:var(--r);margin:14px auto;max-width:700px;padding:13px 20px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow);flex-wrap:wrap}
.speed-bar label{font-weight:800;font-size:.92rem;white-space:nowrap}
#speed-slider{flex:1;min-width:120px;accent-color:var(--sky);cursor:pointer}
#speed-val{font-weight:900;color:var(--coral);font-size:1rem;min-width:40px;text-align:center;background:#fff5f5;border-radius:8px;padding:2px 6px}
.speed-info{font-size:.76rem;color:#888;width:100%}

.wordlist-banner{background:linear-gradient(90deg,var(--sun),var(--peach));border-radius:var(--r);margin:0 auto 16px;max-width:700px;padding:13px 18px;box-shadow:var(--shadow)}
.wordlist-banner h3{font-family:'Baloo 2',cursive;font-size:.98rem;color:var(--ink);margin-bottom:8px}
.word-chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{background:rgba(255,255,255,.75);border-radius:50px;padding:4px 11px;font-size:.8rem;font-weight:700;cursor:pointer;border:2px solid rgba(255,255,255,.9);transition:background .2s,transform .15s;color:var(--ink);user-select:none}
.chip:hover{background:#fff;transform:scale(1.05)}
.chip.on{background:var(--hl)}

.sec-title{text-align:center;font-family:'Baloo 2',cursive;font-size:clamp(1.1rem,4vw,1.8rem);margin:22px 0 11px;color:var(--ink)}
.sec-title span{background:linear-gradient(135deg,var(--coral),var(--lavender));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

.story{max-width:700px;margin:0 auto;padding:0 13px}
.pcard{background:var(--card);border-radius:var(--r);padding:17px 20px;margin-bottom:15px;box-shadow:var(--shadow);border-left:5px solid var(--sky)}
.pcard:nth-child(4n+2){border-left-color:var(--lavender)}
.pcard:nth-child(4n+3){border-left-color:var(--grass)}
.pcard:nth-child(4n+4){border-left-color:var(--coral)}
.para-en{font-size:1rem;line-height:1.95;color:var(--ink)}
.vw{color:#1A6ED8;background:#E8F4FF;border-radius:6px;padding:1px 5px;cursor:pointer;font-weight:800;border-bottom:2px solid #1A6ED8;transition:background .18s,color .18s}
.vw:hover{background:var(--hlw);color:#0A3D8F}
.vw.on{background:var(--hl);color:#7a4000;border-bottom-color:#E8A000}
.ssen.on{background:var(--hl);border-radius:4px}
.para-zh{display:none;margin-top:11px;padding:11px 13px;background:linear-gradient(135deg,#f0fff4,#e8f4ff);border-radius:12px;font-size:.92rem;line-height:1.8;color:#444;border:1px dashed #aaa}

.pctrl{display:flex;gap:8px;margin-top:11px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 15px;border-radius:50px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.83rem;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.12);transition:transform .15s,box-shadow .15s;user-select:none}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.18)}
.btn:active{transform:scale(.97)}
.bzh{background:linear-gradient(135deg,#a8e6cf,#67d7aa);color:#1a5c3a}
.bread{background:linear-gradient(135deg,var(--sky),#3AAFDF);color:#fff}
.bstop{background:linear-gradient(135deg,#ffb347,#ff8000);color:#fff}

.go-quiz{display:block;margin:13px auto 28px;background:linear-gradient(135deg,var(--lavender),#9B59D8);color:#fff;padding:12px 28px;border-radius:50px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:800;box-shadow:0 4px 14px rgba(195,166,255,.5);transition:transform .15s;user-select:none}
.go-quiz:hover{transform:scale(1.05)}

.qsec{max-width:700px;margin:8px auto 0;padding:0 13px}
.qintro{background:linear-gradient(135deg,var(--lavender),#e8c5ff);border-radius:var(--r);padding:16px 20px;margin-bottom:16px;text-align:center;box-shadow:var(--shadow)}
.qintro p{font-size:.93rem;font-weight:700;color:var(--ink)}
.qintro p+p{font-size:.8rem;color:#555;margin-top:4px}

.qcard{background:var(--card);border-radius:var(--r);padding:17px 20px;margin-bottom:15px;box-shadow:var(--shadow);border-top:4px solid var(--lavender)}
.qcard.qok{border-top-color:var(--grass)}.qcard.qno{border-top-color:var(--coral)}
.qhdr{display:flex;align-items:flex-start;gap:9px;margin-bottom:11px}
.qnum{background:var(--lavender);color:#fff;border-radius:50%;width:29px;height:29px;min-width:29px;text-align:center;line-height:29px;font-size:.83rem;font-weight:900}
.qtxt{font-size:.97rem;font-weight:700;line-height:1.6;flex:1}
.qtxt.on{background:var(--hl);border-radius:8px;padding:2px 6px}
.qspk{background:none;border:none;cursor:pointer;font-size:1.2rem;padding:2px 4px;border-radius:8px;transition:transform .15s,background .2s;line-height:1;flex-shrink:0}
.qspk:hover{background:#eee;transform:scale(1.15)}
.qspk.on{background:var(--hl)}

.ogrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:3px}
@media(max-width:480px){.ogrid{grid-template-columns:1fr}}
.obtn{background:#F4F0FF;border:2px solid #D4C8FF;border-radius:12px;padding:9px 13px;text-align:left;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:600;color:var(--ink);transition:background .18s,border-color .18s,transform .12s;user-select:none}
.obtn:hover:not(:disabled){background:#E4D8FF;border-color:#A78BE0;transform:scale(1.02)}
.obtn.sel{background:#D4C8FF;border-color:#7C4DFF;font-weight:800}
.obtn.ok{background:#C8F5D5;border-color:var(--grass);color:#1a5c3a;font-weight:800}
.obtn.no{background:#FFD6D6;border-color:var(--coral);color:#8B1A1A;font-weight:800}
.obtn:disabled{cursor:default}

.qfb{display:none;margin-top:9px;padding:7px 13px;border-radius:10px;font-weight:700;font-size:.87rem}
.fbok{background:#d4edda;color:#155724}.fbno{background:#f8d7da;color:#721c24}

.submit-row{text-align:center;margin:9px 0 22px}
.bsub{background:linear-gradient(135deg,var(--grass),#4CAF50);color:#fff;font-size:1.05rem;padding:13px 36px;border-radius:50px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;box-shadow:0 4px 18px rgba(107,203,119,.45);transition:transform .15s,opacity .2s;user-select:none}
.bsub:hover{transform:scale(1.04)}.bsub:disabled{opacity:.5;cursor:default;transform:none}

.scoreboard{display:none;background:linear-gradient(135deg,var(--sun),var(--peach));border-radius:var(--r);padding:24px 20px;margin:16px auto 0;max-width:700px;text-align:center;box-shadow:var(--shadow)}
.scoreboard.show{display:block}
.scoreboard h2{font-family:'Baloo 2',cursive;font-size:1.7rem;color:var(--ink);margin-bottom:8px}
.scorebig{font-family:'Baloo 2',cursive;font-size:3.8rem;color:var(--coral);line-height:1;text-shadow:3px 3px 0 rgba(0,0,0,.1)}
.scoremsg{font-size:.97rem;font-weight:700;color:#555;margin-top:8px}
.bretry{margin-top:15px;background:linear-gradient(135deg,var(--coral),#FF3333);color:#fff;font-size:1rem;padding:11px 26px;border-radius:50px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:800;box-shadow:0 4px 14px rgba(255,107,107,.4);transition:transform .15s;user-select:none}
.bretry:hover{transform:scale(1.05)}
footer{text-align:center;padding:22px;color:#999;font-size:.78rem;margin-top:8px}
footer span{color:var(--coral)}
</style>
</head>
<body>

<header>
  <h1>ğŸŒŸ Amy and the Treasure Map ğŸŒŸ</h1>
  <p>å››å¹´ç´šè‹±èªæ•…äº‹ &amp; é–±è®€æ¸¬é©— ï½œ é»æ“Šè—è‰²å–®å­—å¯ä»¥è½ç™¼éŸ³ ğŸ”Š</p>
</header>

<div class="speed-bar">
  <label for="speed-slider">ğŸ¢ ç™¼éŸ³é€Ÿåº¦</label>
  <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.1" value="0.9">
  <span id="speed-val">0.9Ã—</span>
  <span class="speed-info">å»ºè­°å°æœ‹å‹å¾ 0.7Ã— é–‹å§‹ï¼Œç·´ç†Ÿäº†å†èª¿å¿« ğŸš€</span>
</div>

<div class="wordlist-banner">
  <h3>ğŸ“š æœ¬èª²é‡é»å–®å­— â€” é»ä¸€ä¸‹å°±èƒ½è½ç™¼éŸ³ï¼</h3>
  <div class="word-chips" id="wchips"></div>
</div>

<h2 class="sec-title"><span>ğŸ“– æ•…äº‹é–‹å§‹å›‰ï¼</span></h2>
<div class="story" id="story"></div>

<button class="go-quiz" id="go-quiz-btn">ğŸ§© é–‹å§‹é–±è®€æ¸¬é©—ï¼</button>

<h2 class="sec-title" id="quiz-anchor"><span>ğŸ“ é–±è®€æ¸¬é©— Reading Quiz</span></h2>
<div class="qsec">
  <div class="qintro">
    <p>ğŸ“– æ ¹æ“šæ•…äº‹å›ç­”ä»¥ä¸‹ 5 é¡Œï¼Œæ¯é¡Œé¸ä¸€å€‹æœ€æ­£ç¢ºçš„ç­”æ¡ˆã€‚</p>
    <p>Read the story carefully and choose the best answer for each question.</p>
  </div>
  <div id="qcont"></div>
  <div class="submit-row">
    <button class="bsub" id="sub-btn">ğŸ¯ æäº¤ç­”æ¡ˆ Submit</button>
  </div>
</div>

<div class="scoreboard" id="scoreboard">
  <h2>ğŸ† æ¸¬é©—çµæœ Quiz Result ğŸ†</h2>
  <div class="scorebig" id="scorebig">0 / 5</div>
  <div class="scoremsg" id="scoremsg"></div>
  <button class="bretry" id="retry-btn">ğŸ”„ å†è©¦ä¸€æ¬¡ Try Again</button>
</div>

<footer><p>âœ¨ è¨­è¨ˆçµ¦åŠªåŠ›å­¸ç¿’è‹±èªçš„å°æœ‹å‹ âœ¨ ï½œ <span>Amy and the Treasure Map</span> Â© 2025</p></footer>

<script>
/* =========================================================
   DATA
   ========================================================= */
var VOCAB = [
  ["bookstore","æ›¸åº—"],["restaurant","é¤å»³"],["hospital","é†«é™¢"],
  ["bakery","éºµåŒ…åº—"],["bank","éŠ€è¡Œ"],["post office","éƒµå±€"],
  ["post","éƒµæ”¿/éƒµä»¶"],["office","è¾¦å…¬å®¤"],["bike","è…³è¸è»Š"],
  ["scooter","æ©Ÿè»Š"],["taxi","è¨ˆç¨‹è»Š"],["bus","å…¬è»Š"],
  ["train","ç«è»Š"],["car","æ±½è»Š"],["MRT","æ·é‹"],["plane","é£›æ©Ÿ"],
  ["dress","æ´‹è£"],["skirt","è£™å­"],["T-shirt","Tæ¤"],["shorts","çŸ­è¤²"],
  ["sneakers","é‹å‹•é‹"],["pants","è¤²å­/é•·è¤²"],["sweater","æ¯›è¡£"],
  ["jacket","å¤¾å…‹/å¤–å¥—"],["smartphone","æ™ºæ…§å‹æ‰‹æ©Ÿ"],["phone","é›»è©±/æ‰‹æ©Ÿ"],
  ["smart","è°æ˜çš„"],["umbrella","é›¨å‚˜"],["water bottle","æ°´å£º/æ°´ç“¶"],
  ["glasses","çœ¼é¡"],["glass","ç»ç’ƒæ¯"]
];
// sort longest first so "post office" matched before "post", "water bottle" before "water", "glasses" before "glass", "smartphone" before "phone", "T-shirt" before "shirt"
VOCAB.sort(function(a,b){ return b[0].length - a[0].length; });

var PARAS = [
  {
    en:"Amy loved sunny mornings. She put on her favorite T-shirt and shorts, then put on her sneakers. She grabbed her water bottle and glasses. Her smartphone beeped â€” a message from her friend Ben said, \"Come to the bakery now! I have something fun for you!\"",
    zh:"è‰¾å’ªå–œæ­¡æ™´æœ—çš„æ—©æ™¨ã€‚å¥¹ç©¿ä¸Šå¥¹æœ€å–œæ­¡çš„Tæ¤å’ŒçŸ­è¤²ï¼Œç„¶å¾Œç©¿ä¸Šé‹å‹•é‹ã€‚å¥¹æ‹¿èµ·æ°´å£ºå’Œçœ¼é¡ã€‚å¥¹çš„æ™ºæ…§å‹æ‰‹æ©ŸéŸ¿äº†ä¸€è²â€”â€”æœ‹å‹ Ben å‚³ä¾†è¨Šæ¯ï¼šã€Œå¿«ä¾†éºµåŒ…åº—ï¼æˆ‘æœ‰å¥½ç©çš„æ±è¥¿è¦çµ¦ä½ ï¼ã€"
  },
  {
    en:"Amy jumped on her bike and rode down the street. She passed the post office and saw a man on a scooter delivering letters. At the bakery, Ben was holding a small box. \"Look!\" he said. Inside was a small map. \"My dad made a treasure hunt for us!\" Ben said with a big smile.",
    zh:"è‰¾å’ªè·³ä¸Šè…³è¸è»Šï¼Œæ²¿è‘—è¡—é“é¨å»ã€‚å¥¹ç¶“ééƒµå±€ï¼Œçœ‹è¦‹ä¸€å€‹é¨æ©Ÿè»Šçš„äººæ­£åœ¨é€ä¿¡ã€‚åœ¨éºµåŒ…åº—ï¼ŒBen æ‰‹è£¡æ‹¿è‘—ä¸€å€‹å°ç›’å­ã€‚ã€Œä½ çœ‹ï¼ã€ä»–èªªã€‚è£¡é¢æ˜¯ä¸€å¼µå°åœ°åœ–ã€‚ã€Œæˆ‘çˆ¸çˆ¸å¹«æˆ‘å€‘åšäº†ä¸€å€‹å°‹å¯¶éŠæˆ²ï¼ã€Ben é–‹å¿ƒåœ°ç¬‘è‘—èªªã€‚"
  },
  {
    en:"The first clue said, \"Go to the place where people send post.\" They ran to the post office. The kind lady working in the office handed them the next clue. \"You two are so smart!\" she said. The new clue told them to find the place where people keep money, so they walked to the bank.",
    zh:"ç¬¬ä¸€æ¢ç·šç´¢å¯«è‘—ï¼šã€Œå»äººå€‘å¯„éƒµä»¶çš„åœ°æ–¹ã€‚ã€ä»–å€‘è·‘åˆ°éƒµå±€ã€‚åœ¨è¾¦å…¬å®¤è£¡å·¥ä½œçš„å¥½å¿ƒé˜¿å§¨æŠŠä¸‹ä¸€æ¢ç·šç´¢äº¤çµ¦ä»–å€‘ã€‚ã€Œä½ å€‘å…©å€‹çœŸè°æ˜ï¼ã€å¥¹èªªã€‚æ–°çš„ç·šç´¢å«ä»–å€‘å»æ‰¾äººå€‘å­˜éŒ¢çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä»–å€‘èµ°åˆ°äº†éŠ€è¡Œã€‚"
  },
  {
    en:"At the bank, a guard gave them another clue. It said, \"Take the bus to the big bookstore.\" They got on the bus and rode to the bookstore near the MRT station. A man with glasses showed them a clue hidden inside a book about planes and trains.",
    zh:"åœ¨éŠ€è¡Œï¼Œä¸€ä½è­¦è¡›çµ¦äº†ä»–å€‘å¦ä¸€æ¢ç·šç´¢ã€‚ä¸Šé¢å¯«è‘—ï¼šã€Œæ­å…¬è»Šå»é‚£å®¶å¤§æ›¸åº—ã€‚ã€ä»–å€‘ä¸Šäº†å…¬è»Šï¼Œååˆ°æ·é‹ç«™é™„è¿‘çš„æ›¸åº—ã€‚ä¸€å€‹æˆ´çœ¼é¡çš„ç”·äººçµ¦ä»–å€‘çœ‹ä¸€æœ¬é—œæ–¼é£›æ©Ÿå’Œç«è»Šçš„æ›¸è£¡è—è‘—çš„ç·šç´¢ã€‚"
  },
  {
    en:"The next clue told them to go to the restaurant across the street. They sat down and each drank a glass of cold water. The waiter brought the next clue on a plate. \"Go to the place where doctors help people,\" it said. So they took the MRT to the hospital.",
    zh:"ä¸‹ä¸€æ¢ç·šç´¢å«ä»–å€‘å»è¡—å°é¢çš„é¤å»³ã€‚ä»–å€‘åä¸‹ä¾†ï¼Œå„å–äº†ä¸€æ¯å†°æ°´ã€‚æœå‹™ç”ŸæŠŠä¸‹ä¸€æ¢ç·šç´¢æ”¾åœ¨ç›¤å­ä¸Šç«¯ä¾†ã€‚ä¸Šé¢å¯«è‘—ï¼šã€Œå»é†«ç”Ÿå¹«åŠ©äººå€‘çš„åœ°æ–¹ã€‚ã€æ–¼æ˜¯ä»–å€‘æ­æ·é‹åˆ°äº†é†«é™¢ã€‚"
  },
  {
    en:"At the hospital, a kind nurse gave them the last clue: \"Go back to where you started!\" Dark clouds came, so Amy opened her umbrella. They called a taxi on Amy's phone because the rain was very heavy. The taxi was a big yellow car, and they rode back to the bakery.",
    zh:"åœ¨é†«é™¢ï¼Œä¸€ä½å¥½å¿ƒçš„è­·å£«çµ¦äº†ä»–å€‘æœ€å¾Œä¸€æ¢ç·šç´¢ï¼šã€Œå›åˆ°ä½ å€‘å‡ºç™¼çš„åœ°æ–¹ï¼ã€çƒé›²é£„ä¾†äº†ï¼Œè‰¾å’ªæ’é–‹å¥¹çš„é›¨å‚˜ã€‚ä»–å€‘ç”¨è‰¾å’ªçš„æ‰‹æ©Ÿå«äº†ä¸€è¼›è¨ˆç¨‹è»Šï¼Œå› ç‚ºé›¨ä¸‹å¾—å¾ˆå¤§ã€‚è¨ˆç¨‹è»Šæ˜¯ä¸€è¼›å¤§å¤§çš„é»ƒè‰²æ±½è»Šï¼Œä»–å€‘åå›äº†éºµåŒ…åº—ã€‚"
  },
  {
    en:"When they walked in, Ben's dad was waiting with a big cake. \"You did it!\" he said. Amy's mom came with a surprise â€” a pretty dress, a warm sweater, and a cool jacket for Amy! Mom also had new pants for Dad and a cute skirt for Amy's sister. Amy picked up her phone and called Grandma. \"I want to ride a train or fly on a plane to visit you someday!\" she said. Grandma laughed. \"I can't wait!\" It was truly Amy's lucky day.",
    zh:"ç•¶ä»–å€‘èµ°é€²å»çš„æ™‚å€™ï¼ŒBen çš„çˆ¸çˆ¸æ­£æ‹¿è‘—ä¸€å€‹å¤§è›‹ç³•ç­‰è‘—ä»–å€‘ã€‚ã€Œä½ å€‘åšåˆ°äº†ï¼ã€ä»–èªªã€‚è‰¾å’ªçš„åª½åª½ä¹Ÿå¸¶ä¾†äº†é©šå–œâ€”â€”ä¸€ä»¶æ¼‚äº®çš„æ´‹è£ã€ä¸€ä»¶æº«æš–çš„æ¯›è¡£ï¼Œå’Œä¸€ä»¶å¸¥æ°£çš„å¤¾å…‹é€çµ¦è‰¾å’ªï¼åª½åª½ä¹Ÿå¸¶äº†æ–°çš„é•·è¤²çµ¦çˆ¸çˆ¸ï¼Œå’Œä¸€æ¢å¯æ„›çš„è£™å­çµ¦è‰¾å’ªçš„å¦¹å¦¹ã€‚è‰¾å’ªæ‹¿èµ·æ‰‹æ©Ÿæ‰“é›»è©±çµ¦å¥¶å¥¶ã€‚ã€Œæˆ‘æƒ³æœ‰ä¸€å¤©æ­ç«è»Šæˆ–åé£›æ©Ÿå»çœ‹ä½ ï¼ã€å¥¹èªªã€‚å¥¶å¥¶ç¬‘è‘—èªªï¼šã€Œæˆ‘ç­‰ä¸åŠäº†ï¼ã€é€™çœŸçš„æ˜¯è‰¾å’ªæœ€å¹¸é‹çš„ä¸€å¤©ã€‚"
  }
];

var QUESTIONS = [
  {q:"What was Amy wearing when she left home?",
   opts:["A. A dress and a sweater","B. A T-shirt, shorts, and sneakers","C. A skirt and a jacket","D. Pants and a sweater"],ans:"B"},
  {q:"How did Amy go to the bakery to meet Ben?",
   opts:["A. By bus","B. By taxi","C. By bike","D. By MRT"],ans:"C"},
  {q:"Where did Amy and Ben go after the bank?",
   opts:["A. To the hospital","B. To the restaurant","C. To the bookstore","D. To the post office"],ans:"C"},
  {q:"Why did Amy and Ben take a taxi back to the bakery?",
   opts:["A. They were tired of walking","B. It was raining very hard","C. The bus was too slow","D. The bakery was very far away"],ans:"B"},
  {q:"What surprise did Amy's mom bring at the end of the story?",
   opts:["A. A new smartphone and glasses","B. A big cake and some water","C. A dress, a sweater, and a jacket","D. A T-shirt and shorts"],ans:"C"}
];

/* =========================================================
   STATE
   ========================================================= */
var rate = 0.9;
var answers = {};
var submitted = false;
var activeReadBtn = null;

/* =========================================================
   SPEECH
   ========================================================= */
function stopAll() {
  try { window.speechSynthesis.cancel(); } catch(e){}
  var els;
  els = document.getElementsByClassName("on");
  while(els.length){ els[0].classList.remove("on"); }
  if(activeReadBtn){
    activeReadBtn.textContent = "ğŸ”Š æœ—è®€æ•…äº‹";
    activeReadBtn.className = "btn bread";
    activeReadBtn = null;
  }
}

function doSpeak(text, onDone) {
  if(!window.speechSynthesis){ if(onDone) onDone(); return null; }
  var u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = rate;
  u.onend = function(){ if(onDone) onDone(); };
  u.onerror = function(){ if(onDone) onDone(); };
  window.speechSynthesis.speak(u);
  return u;
}

function speakWithHL(text, spans, onDone) {
  if(!window.speechSynthesis){ if(onDone) onDone(); return; }
  var u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = rate;
  // build char offsets
  var offs = [];
  var c = 0;
  for(var i=0;i<spans.length;i++){
    offs.push(c);
    c += spans[i].textContent.length + 1;
  }
  var last = -1;
  u.onboundary = function(e){
    var ci = e.charIndex;
    var idx = 0;
    for(var i=0;i<offs.length;i++){ if(offs[i]<=ci) idx=i; }
    if(idx!==last){
      if(last>=0 && spans[last]) spans[last].classList.remove("on");
      if(spans[idx]) spans[idx].classList.add("on");
      last = idx;
    }
  };
  u.onend = function(){
    for(var i=0;i<spans.length;i++) if(spans[i]) spans[i].classList.remove("on");
    if(onDone) onDone();
  };
  u.onerror = function(){
    for(var i=0;i<spans.length;i++) if(spans[i]) spans[i].classList.remove("on");
    if(onDone) onDone();
  };
  window.speechSynthesis.speak(u);
}

/* =========================================================
   VOCAB PARSER  (char-by-char, no regex)
   ========================================================= */
function isWordChar(ch) {
  if(!ch) return false;
  var c = ch.toLowerCase();
  return (c>='a' && c<='z') || c==='-';
}

// Returns [{type:"t",v:string} | {type:"w",v:string,word:string}]
function parseText(text) {
  var parts = [];
  var i = 0;
  var tlen = text.length;
  while(i < tlen){
    var matched = false;
    for(var vi=0; vi<VOCAB.length; vi++){
      var vw = VOCAB[vi][0];
      var vlen = vw.length;
      // check match at position i (case-insensitive)
      if(i + vlen > tlen) continue;
      var seg = text.slice(i, i+vlen);
      if(seg.toLowerCase() !== vw.toLowerCase()) continue;
      // check word boundaries
      var before = i>0 ? text[i-1] : '';
      var after  = (i+vlen < tlen) ? text[i+vlen] : '';
      if(isWordChar(before)) continue;
      if(isWordChar(after))  continue;
      // matched!
      parts.push({type:"w", v:seg, word:vw});
      i += vlen;
      matched = true;
      break;
    }
    if(!matched){
      if(parts.length && parts[parts.length-1].type==="t"){
        parts[parts.length-1].v += text[i];
      } else {
        parts.push({type:"t", v:text[i]});
      }
      i++;
    }
  }
  return parts;
}

function buildEnEl(text, paraIdx) {
  var p = document.createElement("p");
  p.className = "para-en";
  p.id = "en"+paraIdx;
  var parts = parseText(text);
  for(var i=0;i<parts.length;i++){
    var pt = parts[i];
    if(pt.type==="t"){
      p.appendChild(document.createTextNode(pt.v));
    } else {
      (function(sp, word, displayText){
        sp.className = "vw";
        sp.textContent = displayText;
        var zhArr = [];
        for(var vi=0;vi<VOCAB.length;vi++) if(VOCAB[vi][0].toLowerCase()===word.toLowerCase()){ zhArr.push(VOCAB[vi][1]); break; }
        sp.title = word + " = " + (zhArr[0]||"");
        sp.addEventListener("click", function(e){
          e.stopPropagation();
          stopAll();
          sp.classList.add("on");
          doSpeak(word, function(){ sp.classList.remove("on"); });
        });
        p.appendChild(sp);
      })(document.createElement("span"), pt.word, pt.v);
    }
  }
  return p;
}

/* =========================================================
   BUILD STORY  (no paragraph numbers for natural reading feel)
   ========================================================= */
function buildStory() {
  var cont = document.getElementById("story");
  cont.innerHTML = "";
  for(var pi=0; pi<PARAS.length; pi++){
    var card = document.createElement("div");
    card.className = "pcard";

    var enP = buildEnEl(PARAS[pi].en, pi);
    card.appendChild(enP);

    var zhP = document.createElement("div");
    zhP.className = "para-zh";
    zhP.id = "zh"+pi;
    zhP.textContent = PARAS[pi].zh;
    card.appendChild(zhP);

    var ctrl = document.createElement("div");
    ctrl.className = "pctrl";

    // Chinese toggle button
    (function(idx, zhDiv){
      var bz = document.createElement("button");
      bz.className = "btn bzh";
      bz.textContent = "ğŸ”¤ é¡¯ç¤ºä¸­æ–‡";
      bz.addEventListener("click", function(){
        if(zhDiv.style.display === "block"){
          zhDiv.style.display = "none";
          bz.textContent = "ğŸ”¤ é¡¯ç¤ºä¸­æ–‡";
        } else {
          zhDiv.style.display = "block";
          bz.textContent = "ğŸ”¤ éš±è—ä¸­æ–‡";
        }
      });
      ctrl.appendChild(bz);
    })(pi, zhP);

    // Read aloud button
    (function(idx, enEl){
      var br = document.createElement("button");
      br.className = "btn bread";
      br.textContent = "ğŸ”Š æœ—è®€æ•…äº‹";
      br.addEventListener("click", function(){
        if(activeReadBtn === br){
          stopAll();
          return;
        }
        stopAll();
        activeReadBtn = br;
        br.textContent = "â¹ åœæ­¢æœ—è®€";
        br.className = "btn bstop";
        var spans = enEl.querySelectorAll(".ssen");
        if(spans.length === 0){
          // Wrap sentences in spans for highlighting
          var text = PARAS[idx].en;
          doSpeak(text, function(){
            br.textContent = "ğŸ”Š æœ—è®€æ•…äº‹";
            br.className = "btn bread";
            activeReadBtn = null;
          });
        } else {
          speakWithHL(PARAS[idx].en, Array.prototype.slice.call(spans), function(){
            br.textContent = "ğŸ”Š æœ—è®€æ•…äº‹";
            br.className = "btn bread";
            activeReadBtn = null;
          });
        }
      });
      ctrl.appendChild(br);
    })(pi, enP);

    card.appendChild(ctrl);
    cont.appendChild(card);
  }
}

/* =========================================================
   BUILD WORD CHIPS
   ========================================================= */
function buildChips() {
  var cont = document.getElementById("wchips");
  cont.innerHTML = "";
  for(var i=0; i<VOCAB.length; i++){
    (function(word, zh){
      var chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = word + " " + zh;
      chip.title = word + " = " + zh;
      chip.addEventListener("click", function(){
        stopAll();
        chip.classList.add("on");
        doSpeak(word, function(){ chip.classList.remove("on"); });
      });
      cont.appendChild(chip);
    })(VOCAB[i][0], VOCAB[i][1]);
  }
}

/* =========================================================
   BUILD QUIZ
   ========================================================= */
function buildQuiz() {
  var cont = document.getElementById("qcont");
  cont.innerHTML = "";
  answers = {};
  submitted = false;
  document.getElementById("sub-btn").disabled = false;
  document.getElementById("scoreboard").classList.remove("show");

  for(var qi=0; qi<QUESTIONS.length; qi++){
    var q = QUESTIONS[qi];
    var card = document.createElement("div");
    card.className = "qcard";
    card.id = "qcard"+qi;

    var hdr = document.createElement("div");
    hdr.className = "qhdr";

    var qnum = document.createElement("span");
    qnum.className = "qnum";
    qnum.textContent = (qi+1);
    hdr.appendChild(qnum);

    var qtxt = document.createElement("span");
    qtxt.className = "qtxt";
    qtxt.id = "qtxt"+qi;
    qtxt.textContent = q.q;
    hdr.appendChild(qtxt);

    var spkBtn = document.createElement("button");
    spkBtn.className = "qspk";
    spkBtn.textContent = "ğŸ”Š";
    spkBtn.title = "è½é¡Œç›®";
    (function(text, btn, txt){
      btn.addEventListener("click", function(){
        stopAll();
        btn.classList.add("on");
        txt.classList.add("on");
        doSpeak(text, function(){
          btn.classList.remove("on");
          txt.classList.remove("on");
        });
      });
    })(q.q, spkBtn, qtxt);
    hdr.appendChild(spkBtn);

    card.appendChild(hdr);

    var grid = document.createElement("div");
    grid.className = "ogrid";

    for(var oi=0; oi<q.opts.length; oi++){
      (function(qIdx, optIdx, optText, letter, myGrid){
        var ob = document.createElement("button");
        ob.className = "obtn";
        ob.textContent = optText;
        ob.addEventListener("click", function(){
          if(submitted) return;
          // deselect others in same question
          var siblings = myGrid.querySelectorAll(".obtn");
          for(var s=0; s<siblings.length; s++) siblings[s].classList.remove("sel");
          ob.classList.add("sel");
          answers[qIdx] = letter;
        });
        myGrid.appendChild(ob);
      })(qi, oi, q.opts[oi], String.fromCharCode(65+oi), grid);
    }

    card.appendChild(grid);

    var fb = document.createElement("div");
    fb.className = "qfb";
    fb.id = "qfb"+qi;
    card.appendChild(fb);

    cont.appendChild(card);
  }
}

/* =========================================================
   SUBMIT QUIZ
   ========================================================= */
function submitQuiz() {
  if(submitted) return;

  // Check all answered
  var total = QUESTIONS.length;
  var answered = Object.keys(answers).length;
  if(answered < total){
    alert("è«‹å…ˆå›ç­”æ‰€æœ‰ " + total + " é¡Œå–”ï¼\nPlease answer all " + total + " questions first!");
    return;
  }

  submitted = true;
  document.getElementById("sub-btn").disabled = true;

  var score = 0;
  for(var qi=0; qi<QUESTIONS.length; qi++){
    var q = QUESTIONS[qi];
    var card = document.getElementById("qcard"+qi);
    var fb = document.getElementById("qfb"+qi);
    var userAns = answers[qi];
    var correct = q.ans;
    var isCorrect = (userAns === correct);

    if(isCorrect){
      score++;
      card.classList.add("qok");
      fb.className = "qfb fbok";
      fb.textContent = "âœ… æ­£ç¢ºï¼Great job!";
    } else {
      card.classList.add("qno");
      fb.className = "qfb fbno";
      var correctIdx = correct.charCodeAt(0) - 65;
      fb.textContent = "âŒ æ­£ç¢ºç­”æ¡ˆæ˜¯ " + q.opts[correctIdx];
    }
    fb.style.display = "block";

    // Highlight correct/wrong options
    var btns = card.querySelectorAll(".obtn");
    for(var bi=0; bi<btns.length; bi++){
      btns[bi].disabled = true;
      var letter = String.fromCharCode(65+bi);
      if(letter === correct){
        btns[bi].classList.add("ok");
      } else if(letter === userAns && !isCorrect){
        btns[bi].classList.add("no");
      }
    }
  }

  // Show scoreboard
  var sb = document.getElementById("scoreboard");
  document.getElementById("scorebig").textContent = score + " / " + total;
  var msg = "";
  if(score === total) msg = "ğŸ‰ æ»¿åˆ†ï¼ä½ å¤ªå²å®³äº†ï¼Perfect score!";
  else if(score >= 4) msg = "ğŸ‘ éå¸¸æ£’ï¼Almost perfect!";
  else if(score >= 3) msg = "ğŸ˜Š ä¸éŒ¯å–”ï¼Good job!";
  else if(score >= 2) msg = "ğŸ’ª åŠ æ²¹ï¼å†è®€ä¸€æ¬¡æ•…äº‹è©¦è©¦ï¼Keep trying!";
  else msg = "ğŸ“– å†ä»”ç´°è®€ä¸€æ¬¡æ•…äº‹å§ï¼Read the story again!";
  document.getElementById("scoremsg").textContent = msg;
  sb.classList.add("show");
  sb.scrollIntoView({behavior:"smooth", block:"center"});
}

/* =========================================================
   INIT
   ========================================================= */
document.addEventListener("DOMContentLoaded", function(){
  // Speed slider
  var slider = document.getElementById("speed-slider");
  var sval = document.getElementById("speed-val");
  slider.addEventListener("input", function(){
    rate = parseFloat(slider.value);
    sval.textContent = rate.toFixed(1) + "Ã—";
  });

  // Build everything
  buildChips();
  buildStory();
  buildQuiz();

  // Go to quiz button
  document.getElementById("go-quiz-btn").addEventListener("click", function(){
    document.getElementById("quiz-anchor").scrollIntoView({behavior:"smooth"});
  });

  // Submit button
  document.getElementById("sub-btn").addEventListener("click", submitQuiz);

  // Retry button
  document.getElementById("retry-btn").addEventListener("click", function(){
    buildQuiz();
    document.getElementById("quiz-anchor").scrollIntoView({behavior:"smooth"});
  });
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The King's Summer Camp â€” English Listening Story Quiz</title>
<style>
:root {
  --sky: #5BC8F5; --sun: #FFD93D; --grass: #6BCB77; --coral: #FF6B6B;
  --lavender: #C3A6FF; --peach: #FFB347; --ink: #2D3047; --card: #FFFDF5;
  --shadow: 0 4px 20px rgba(45,48,71,.10); --r: 18px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', 'Noto Sans TC', 'PingFang TC', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(160deg, #e0f7fa, #fff9e6 50%, #fce4f0);
  min-height: 100vh; color: var(--ink); padding-bottom: 60px;
  -webkit-tap-highlight-color: transparent;
}

header {
  background: linear-gradient(135deg, #7B68EE, var(--sky));
  padding: 28px 20px 22px; text-align: center;
  box-shadow: 0 6px 24px rgba(91,200,245,.35);
}
header h1 {
  font-size: clamp(1.4rem, 5vw, 2.4rem); color: #fff; font-weight: 900;
  text-shadow: 3px 3px 0 rgba(0,0,0,.12); line-height: 1.3;
}
header p { color: rgba(255,255,255,.92); font-size: .88rem; margin-top: 6px; font-weight: 700; }

.container { max-width: 740px; margin: 0 auto; padding: 0 14px; }

.ctrl-panel {
  background: #fff; border-radius: var(--r); margin: 16px auto; max-width: 740px;
  padding: 16px 20px; box-shadow: var(--shadow);
}
.ctrl-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
.ctrl-row:last-child { margin-bottom: 0; }
.ctrl-label { font-weight: 800; font-size: .9rem; white-space: nowrap; min-width: 100px; }
.diff-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.diff-btn {
  padding: 7px 18px; border-radius: 50px; border: 2.5px solid #ddd; cursor: pointer;
  font-family: inherit; font-size: .85rem; font-weight: 800; background: #f8f8f8;
  transition: all .2s; user-select: none;
}
.diff-btn:hover { transform: scale(1.04); }
.diff-btn.active-easy { background: #d4edda; border-color: var(--grass); color: #155724; }
.diff-btn.active-medium { background: #fff3cd; border-color: var(--peach); color: #856404; }
.diff-btn.active-hard { background: #f8d7da; border-color: var(--coral); color: #721c24; }
#speed-slider { flex: 1; min-width: 100px; accent-color: var(--sky); cursor: pointer; height: 6px; }
#speed-val {
  font-weight: 900; color: var(--coral); font-size: .95rem; min-width: 42px;
  text-align: center; background: #fff5f5; border-radius: 8px; padding: 3px 8px;
}
.ctrl-hint { font-size: .75rem; color: #999; width: 100%; margin-top: 2px; }

.chip-banner {
  background: linear-gradient(90deg, var(--sun), var(--peach));
  border-radius: var(--r); margin: 0 auto 12px; max-width: 740px;
  padding: 14px 18px; box-shadow: var(--shadow);
}
.chip-banner h3 { font-size: .95rem; font-weight: 800; color: var(--ink); margin-bottom: 8px; }
.chips { display: flex; flex-wrap: wrap; gap: 6px; }
.chip {
  background: rgba(255,255,255,.78); border-radius: 50px; padding: 4px 12px;
  font-size: .8rem; font-weight: 700; cursor: pointer; border: 2px solid rgba(255,255,255,.9);
  transition: background .2s, transform .15s; color: var(--ink); user-select: none;
}
.chip:hover { background: #fff; transform: scale(1.05); }
.chip.speaking { background: #FFE566; }

.sec-title {
  text-align: center; font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: 900;
  margin: 22px 0 12px; color: var(--ink);
}
.sec-title span {
  background: linear-gradient(135deg, var(--coral), var(--lavender));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.progress-wrap { max-width: 740px; margin: 0 auto 14px; padding: 0 14px; }
.progress-bar-outer {
  background: #e8e8e8; border-radius: 50px; height: 28px; position: relative;
  overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,.08);
}
.progress-bar-inner {
  background: linear-gradient(90deg, var(--grass), #4CAF50);
  height: 100%; border-radius: 50px; transition: width .5s ease;
  display: flex; align-items: center; justify-content: center; min-width: 40px;
}
.progress-text {
  font-size: .78rem; font-weight: 800; color: #fff;
  text-shadow: 1px 1px 1px rgba(0,0,0,.2); white-space: nowrap; padding: 0 10px;
}

.pcard {
  background: var(--card); border-radius: var(--r); padding: 18px 20px;
  margin-bottom: 14px; box-shadow: var(--shadow); border-left: 5px solid var(--sky);
}
.pcard:nth-child(4n+2) { border-left-color: var(--lavender); }
.pcard:nth-child(4n+3) { border-left-color: var(--grass); }
.pcard:nth-child(4n) { border-left-color: var(--coral); }
.para-en { font-size: 1.05rem; line-height: 2.2; color: var(--ink); }
.vw {
  color: #1A6ED8; background: #E8F4FF; border-radius: 6px; padding: 1px 5px;
  cursor: pointer; font-weight: 800; border-bottom: 2px solid #1A6ED8;
  transition: background .18s, color .18s;
}
.vw:hover { background: #B5F2FF; color: #0A3D8F; }
.vw.speaking { background: #FFE566; color: #7a4000; border-bottom-color: #E8A000; }
.ssen {
  transition: background .3s; border-radius: 4px;
  box-decoration-break: clone; -webkit-box-decoration-break: clone;
}
.ssen.highlight { background: #FFF3CD; padding: 2px 0; }
.ssen.playing-sentence { background: #E3F2FD; padding: 3px 2px; border-radius: 6px; }
.para-zh {
  display: none; margin-top: 10px; padding: 10px 14px;
  background: linear-gradient(135deg, #f0fff4, #e8f4ff); border-radius: 12px;
  font-size: .9rem; line-height: 1.8; color: #555; border: 1px dashed #bbb;
}

.blank-wrap { display: inline-block; vertical-align: baseline; position: relative; }
.blank-speaker {
  display: inline-flex; align-items: center; justify-content: center; gap: 4px;
  background: linear-gradient(135deg, #FFE0B2, #FFCC80); border: 2.5px dashed #FF9800;
  border-radius: 10px; padding: 3px 12px; cursor: pointer; font-size: .92rem;
  transition: transform .15s, box-shadow .2s; user-select: none;
  animation: pulse-blank 2s infinite;
  min-width: 60px; min-height: 34px; line-height: 1; font-weight: 700;
  color: #E65100; letter-spacing: 1px;
}
.blank-speaker:hover { transform: scale(1.06); box-shadow: 0 2px 12px rgba(255,152,0,.35); }
.blank-speaker:active { transform: scale(.96); }
@keyframes pulse-blank {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,152,0,.3); }
  50% { box-shadow: 0 0 0 6px rgba(255,152,0,0); }
}
.blank-hint {
  display: block; text-align: center; font-size: .7rem; color: #999;
  padding: 4px 0 2px; font-weight: 600;
}
.blank-opts-popup {
  display: none; position: absolute; top: calc(100% + 6px); left: 50%;
  transform: translateX(-50%); z-index: 200; background: #fff;
  border-radius: 14px; box-shadow: 0 6px 28px rgba(0,0,0,.2);
  padding: 10px; min-width: 210px; animation: pop-in .25s ease;
}
.blank-opts-popup.show { display: flex; flex-direction: column; gap: 5px; }
.blank-opts-popup::before {
  content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
  border-left: 8px solid transparent; border-right: 8px solid transparent;
  border-bottom: 8px solid #fff;
}
.blank-opt-btn {
  padding: 9px 14px; border-radius: 10px; border: 2px solid #ddd; background: #f9f9f9;
  cursor: pointer; font-family: inherit; font-size: .9rem; font-weight: 700;
  color: var(--ink); transition: all .15s; text-align: center; user-select: none;
}
.blank-opt-btn:hover:not(.wrong) { background: #E8F4FF; border-color: var(--sky); transform: scale(1.03); }
.blank-opt-btn.correct {
  background: #d4edda; border-color: var(--grass); color: #155724;
  animation: pop-in .3s ease;
}
.blank-opt-btn.wrong {
  background: #f8d7da; border-color: var(--coral); color: #721c24;
  animation: shake .4s ease; pointer-events: none; opacity: .45;
}
.blank-solved {
  display: inline; color: #155724; background: #d4edda; border-radius: 6px;
  padding: 1px 6px; font-weight: 800; border-bottom: 2px solid var(--grass);
  animation: pop-in .3s ease; cursor: pointer;
}

.pctrl { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
.btn {
  display: inline-flex; align-items: center; gap: 5px; padding: 7px 15px;
  border-radius: 50px; border: none; cursor: pointer; font-family: inherit;
  font-size: .82rem; font-weight: 700; box-shadow: 0 2px 8px rgba(0,0,0,.1);
  transition: transform .15s, box-shadow .15s; user-select: none;
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.16); }
.btn:active { transform: scale(.97); }
.btn-zh { background: linear-gradient(135deg, #a8e6cf, #67d7aa); color: #1a5c3a; }
.btn-read { background: linear-gradient(135deg, var(--sky), #3AAFDF); color: #fff; }
.btn-stop { background: linear-gradient(135deg, #ffb347, #ff8000); color: #fff; }

.go-quiz {
  display: block; margin: 16px auto 30px;
  background: linear-gradient(135deg, var(--lavender), #9B59D8); color: #fff;
  padding: 13px 30px; border-radius: 50px; border: none; cursor: pointer;
  font-family: inherit; font-size: 1.05rem; font-weight: 800;
  box-shadow: 0 4px 14px rgba(195,166,255,.5); transition: transform .15s;
}
.go-quiz:hover { transform: scale(1.05); }

.qsec { max-width: 740px; margin: 8px auto 0; padding: 0 14px; }
.qintro {
  background: linear-gradient(135deg, var(--lavender), #e8c5ff);
  border-radius: var(--r); padding: 16px 20px; margin-bottom: 16px;
  text-align: center; box-shadow: var(--shadow);
}
.qintro p { font-size: .92rem; font-weight: 700; color: var(--ink); }
.qintro p + p { font-size: .8rem; color: #555; margin-top: 4px; }
.qcard {
  background: var(--card); border-radius: var(--r); padding: 18px 20px;
  margin-bottom: 14px; box-shadow: var(--shadow); border-top: 4px solid var(--lavender);
}
.qcard.qok { border-top-color: var(--grass); }
.qcard.qno { border-top-color: var(--coral); }
.qhdr { display: flex; align-items: flex-start; gap: 9px; margin-bottom: 10px; }
.qnum {
  background: var(--lavender); color: #fff; border-radius: 50%;
  width: 30px; height: 30px; min-width: 30px; text-align: center;
  line-height: 30px; font-size: .85rem; font-weight: 900;
}
.qtxt { font-size: .95rem; font-weight: 700; line-height: 1.6; flex: 1; }
.qtxt-hidden {
  display: inline-flex; align-items: center; gap: 6px;
  color: #FF9800; font-style: italic;
}
.qspk {
  background: none; border: none; cursor: pointer; font-size: 1.2rem;
  padding: 2px 6px; border-radius: 8px; transition: transform .15s, background .2s;
  line-height: 1; flex-shrink: 0;
}
.qspk:hover { background: #eee; transform: scale(1.15); }
.qspk.speaking { background: #FFE566; }
.ogrid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 4px; }
@media (max-width: 500px) { .ogrid { grid-template-columns: 1fr; } }
.obtn {
  background: #F4F0FF; border: 2px solid #D4C8FF; border-radius: 12px;
  padding: 10px 14px; text-align: left; cursor: pointer; font-family: inherit;
  font-size: .88rem; font-weight: 600; color: var(--ink);
  transition: background .18s, border-color .18s, transform .12s; user-select: none;
  display: flex; align-items: center; gap: 6px;
}
.obtn:hover:not(:disabled) { background: #E4D8FF; border-color: #A78BE0; transform: scale(1.02); }
.obtn.sel { background: #D4C8FF; border-color: #7C4DFF; font-weight: 800; }
.obtn.ok { background: #C8F5D5; border-color: var(--grass); color: #1a5c3a; font-weight: 800; }
.obtn.no { background: #FFD6D6; border-color: var(--coral); color: #8B1A1A; font-weight: 800; }
.obtn:disabled { cursor: default; }
.obtn .opt-speaker {
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 1.1rem; cursor: pointer; padding: 2px; flex-shrink: 0;
}
.qfb {
  display: none; margin-top: 9px; padding: 8px 14px;
  border-radius: 10px; font-weight: 700; font-size: .85rem;
}
.fbok { background: #d4edda; color: #155724; }
.fbno { background: #f8d7da; color: #721c24; }

.submit-row { text-align: center; margin: 12px 0 22px; }
.bsub {
  background: linear-gradient(135deg, var(--grass), #4CAF50); color: #fff;
  font-size: 1.05rem; padding: 13px 38px; border-radius: 50px; border: none;
  cursor: pointer; font-family: inherit; font-weight: 800;
  box-shadow: 0 4px 18px rgba(107,203,119,.45); transition: transform .15s, opacity .2s;
}
.bsub:hover { transform: scale(1.04); }
.bsub:disabled { opacity: .5; cursor: default; transform: none; }
.scoreboard {
  display: none; background: linear-gradient(135deg, var(--sun), var(--peach));
  border-radius: var(--r); padding: 26px 20px; margin: 16px auto 0;
  max-width: 740px; text-align: center; box-shadow: var(--shadow);
}
.scoreboard.show { display: block; }
.scoreboard h2 { font-size: 1.6rem; font-weight: 900; color: var(--ink); margin-bottom: 8px; }
.score-big {
  font-size: 3.5rem; font-weight: 900; color: var(--coral); line-height: 1;
  text-shadow: 3px 3px 0 rgba(0,0,0,.08);
}
.score-msg { font-size: .95rem; font-weight: 700; color: #555; margin-top: 8px; }
.bretry {
  margin-top: 14px; background: linear-gradient(135deg, var(--coral), #FF3333); color: #fff;
  font-size: 1rem; padding: 11px 26px; border-radius: 50px; border: none; cursor: pointer;
  font-family: inherit; font-weight: 800; box-shadow: 0 4px 14px rgba(255,107,107,.4);
  transition: transform .15s;
}
.bretry:hover { transform: scale(1.05); }

footer {
  text-align: center; padding: 22px; color: #aaa; font-size: .76rem; margin-top: 8px;
}
footer span { color: var(--coral); }

@keyframes pop-in {
  0% { transform: scale(.7); opacity: 0; }
  60% { transform: scale(1.08); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-6px); }
  40% { transform: translateX(6px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
}
@keyframes celebrate {
  0% { transform: scale(1); }
  25% { transform: scale(1.1) rotate(-2deg); }
  50% { transform: scale(1.15) rotate(2deg); }
  75% { transform: scale(1.1) rotate(-1deg); }
  100% { transform: scale(1); }
}

@media (max-width: 480px) {
  header { padding: 20px 14px 16px; }
  .ctrl-panel, .chip-banner { margin-left: 10px; margin-right: 10px; }
  .pcard { padding: 14px 14px; }
  .para-en { font-size: .95rem; line-height: 2; }
  .blank-opts-popup { min-width: 160px; left: 0; transform: none; }
  .blank-opts-popup::before { left: 20px; transform: none; }
}
</style>
</head>
<body>

<header>
  <h1>ğŸ•ï¸ The King's Summer Camp ğŸ‘‘</h1>
  <p>å››å¹´ç´šè‹±èªè½åŠ›æ•…äº‹ ï½œ è½å®Œæ•´å¥å­ï¼Œæ‰¾å‡ºç©ºæ ¼ä¸­çš„å–®å­—ï¼</p>
</header>

<div class="ctrl-panel container">
  <div class="ctrl-row">
    <span class="ctrl-label">ğŸ¯ è½åŠ›é›£åº¦</span>
    <div class="diff-btns" id="diff-btns">
      <button class="diff-btn" data-diff="easy">Easy ç°¡å–®</button>
      <button class="diff-btn" data-diff="medium">Medium ä¸­ç­‰</button>
      <button class="diff-btn" data-diff="hard">Hard å›°é›£</button>
    </div>
  </div>
  <div class="ctrl-row">
    <span class="ctrl-label">ğŸ¢ ç™¼éŸ³é€Ÿåº¦</span>
    <input type="range" id="speed-slider" min="0.5" max="1.2" step="0.05" value="0.85">
    <span id="speed-val">0.85x</span>
  </div>
  <div class="ctrl-hint">é»æ“Šæ•…äº‹ä¸­çš„ ğŸ”Š æœƒæœ—è®€ã€Œæ•´å€‹å¥å­ã€ï¼Œä»”ç´°è½ï¼Œæ‰¾å‡ºç©ºæ ¼è£¡çš„å–®å­—ï¼</div>
</div>

<div class="chip-banner container">
  <h3>ğŸ“š æœ¬èª²é‡é»å–®å­— â€” é»ä¸€ä¸‹è½ç™¼éŸ³ï¼</h3>
  <div class="chips" id="chips"></div>
</div>

<h2 class="sec-title"><span>ğŸ“– æ•…äº‹ï¼šåœ‹ç‹çš„å¤æ—¥éœ²ç‡Ÿ</span></h2>

<div class="progress-wrap">
  <div class="progress-bar-outer">
    <div class="progress-bar-inner" id="prog-bar" style="width:0%">
      <span class="progress-text" id="prog-text">0 / 0</span>
    </div>
  </div>
</div>

<div class="container" id="story"></div>

<button class="go-quiz" id="go-quiz-btn">ğŸ§© é–‹å§‹é–±è®€æ¸¬é©—ï¼Go to Quiz</button>

<h2 class="sec-title" id="quiz-anchor"><span>ğŸ“ é–±è®€æ¸¬é©— Reading Quiz</span></h2>
<div class="qsec">
  <div class="qintro">
    <p>ğŸ“– æ ¹æ“šæ•…äº‹å›ç­”ä»¥ä¸‹ 10 é¡Œï¼Œé¸å‡ºæœ€æ­£ç¢ºçš„ç­”æ¡ˆã€‚</p>
    <p>éƒ¨åˆ†é¡Œç›®æˆ–é¸é …åªæœ‰ ğŸ”Š åœ–ç¤ºï¼Œè«‹ä»”ç´°è½ï¼</p>
  </div>
  <div id="qcont"></div>
  <div class="submit-row">
    <button class="bsub" id="sub-btn">ğŸ¯ æäº¤ç­”æ¡ˆ Submit</button>
  </div>
</div>

<div class="scoreboard" id="scoreboard">
  <h2>ğŸ† æ¸¬é©—çµæœ Quiz Result ğŸ†</h2>
  <div class="score-big" id="score-big">0 / 10</div>
  <div class="score-msg" id="score-msg"></div>
  <button class="bretry" id="retry-btn">ğŸ”„ å†ä¾†ä¸€æ¬¡ Try Again</button>
</div>

<footer><p>âœ¨ å°ˆç‚ºåŠªåŠ›å­¸è‹±èªçš„å°æœ‹å‹è¨­è¨ˆ âœ¨ ï½œ <span>The King's Summer Camp</span> Â© 2025</p></footer>

<script>
/* ============================================================
   VOCABULARY  (sorted longest-first for greedy matching)
   ============================================================ */
var VOCAB = [
  ['birthday party','ç”Ÿæ—¥æ´¾å°'],['butterfly net','æ•èŸ²ç¶²'],
  ['insect box','æ˜†èŸ²ç®±'],['basketball','ç±ƒçƒ'],['volleyball','æ’çƒ'],
  ['binoculars','é›™ç­’æœ›é é¡'],['try again','å†è©¦ä¸€æ¬¡'],
  ['September','ä¹æœˆ'],['beautiful','ç¾éº—çš„'],['breakfast','æ—©é¤'],
  ['newspaper','å ±ç´™'],['badminton','ç¾½æ¯›çƒ'],['tangerine','æŸ‘æ©˜'],
  ['barbecue','çƒ¤è‚‰'],['lollipop','æ£’æ£’ç³–'],['November','åä¸€æœˆ'],
  ['December','åäºŒæœˆ'],['February','äºŒæœˆ'],['homework','å®¶åº­ä½œæ¥­'],
  ['kangaroo','è¢‹é¼ '],['smallest','æœ€å°çš„'],['campfire','ç‡Ÿç«'],
  ['homemade','è‡ªè£½çš„'],['surprise','é©šå–œ'],['tomorrow','æ˜å¤©'],
  ['one day','æœ‰ä¸€å¤©'],['look at','çœ‹è‘—'],
  ['cleaner','æ¸…æ½”åŠ‘'],['camping','éœ²ç‡Ÿ'],['fishing','é‡£é­š'],
  ['trouble','éº»ç…©'],['mistake','éŒ¯èª¤'],['present','ç¦®ç‰©'],
  ['October','åæœˆ'],['January','ä¸€æœˆ'],['without','æ²’æœ‰'],
  ['picture','ç…§ç‰‡'],['healthy','å¥åº·çš„'],
  ['garden','èŠ±åœ’'],['castle','åŸå ¡'],['basket','ç±ƒå­'],
  ['always','ç¸½æ˜¯'],['turtle','çƒé¾œ'],['August','å…«æœˆ'],
  ['before','åœ¨...ä¹‹å‰'],['wizard','å·«å¸«'],['stream','å°æºª'],
  ['pillow','æ•é ­'],['forest','æ£®æ—'],['summer','å¤å¤©'],
  ['enough','è¶³å¤ çš„'],['horses','é¦¬(è¤‡æ•¸)'],
  ['smoke','ç…™'],['dirty','é«’çš„'],['brush','åˆ·'],
  ['teeth','ç‰™é½’(è¤‡æ•¸)'],['tooth','ç‰™é½’(å–®æ•¸)'],['clean','æ¸…æ½”'],
  ['heavy','é‡çš„'],['light','è¼•çš„'],['magic','ç¥å¥‡çš„'],
  ['point','é‡é»'],['trick','æŠŠæˆ²'],['think','æƒ³'],
  ['worry','æ“”å¿ƒ'],['bring','å¸¶ä¾†'],['smile','å¾®ç¬‘'],
  ['bread','éºµåŒ…'],['short','çŸ®çš„'],['paper','ç´™å¼µ'],
  ['watch','æ‰‹éŒ¶'],['habit','ç¿’æ…£'],['still','ä»ç„¶'],
  ['house','æˆ¿å­'],['study','å­¸ç¿’'],['story','æ•…äº‹'],
  ['March','ä¸‰æœˆ'],['April','å››æœˆ'],
  ['July','ä¸ƒæœˆ'],['June','å…­æœˆ'],['love','æ„›'],
  ['walk','èµ°è·¯'],['wait','ç­‰å¾…'],['shop','å•†åº—'],
  ['keep','ä¿æŒ'],['pick','æŒ‘é¸'],['near','é è¿‘'],
  ['soft','æŸ”è»Ÿçš„'],['hard','å …ç¡¬çš„'],['kind','ç¨®é¡'],
  ['rock','çŸ³é ­'],['will','å°‡æœƒ'],['test','è€ƒè©¦'],
  ['fast','å¿«'],['idea','ä¸»æ„'],['have','æœ‰'],
  ['game','éŠæˆ²'],['come','ä¾†'],['easy','å®¹æ˜“çš„'],
  ['wish','å¸Œæœ›'],['much','å¾ˆå¤š'],['plan','è¨ˆç•«'],
  ['tall','é«˜çš„'],['long','é•·çš„'],['thin','ç˜¦çš„'],
  ['with','è·Ÿï¼›ç”¨'],['hair','é ­é«®'],['wall','ç‰†å£'],
  ['rode','rideçš„éå»å¼'],['more','æ›´å¤š'],['only','åƒ…åƒ…'],
  ['peel','å‰çš®'],['tent','å¸³ç¯·'],['ride','é¨'],
  ['king','åœ‹ç‹'],['may','å¯ä»¥'],['let','è®“'],
  ['all','æ‰€æœ‰çš„'],['fat','èƒ–çš„'],['buy','è²·'],
  ['try','è©¦'],['ax','æ–§é ­']
];

var EXTRA_CHIPS = [
  ['make a mistake','çŠ¯éŒ¯'],['play a trick','æƒ¡ä½œåŠ‡'],
  ['saw','seeçš„éå»å¼'],['Why','ç‚ºä»€éº¼'],['When','ä½•æ™‚'],
  ['Where','åœ¨å“ªè£¡'],['How','å¦‚ä½•']
];

/* ============================================================
   STORY PARAGRAPHS
   ============================================================ */
var PARAS = [
  {
    en: "One day, a tall king lived in a big castle with his friends. He had an idea for the summer. \"I wish to go camping in the forest!\" he said with a big smile. He made a plan. They rode horses to find a beautiful spot near a stream. The ride was fast and easy!",
    zh: "æœ‰ä¸€å¤©ï¼Œä¸€ä½é«˜å¤§çš„åœ‹ç‹å’Œæœ‹å‹å€‘ä½åœ¨ä¸€åº§å¤§åŸå ¡è£¡ã€‚ä»–æœ‰ä¸€å€‹å¤å¤©çš„é»å­ã€‚ã€Œæˆ‘æƒ³å»æ£®æ—éœ²ç‡Ÿï¼ã€ä»–ç¬‘è‘—èªªã€‚ä»–åšäº†ä¸€å€‹è¨ˆç•«ã€‚ä»–å€‘é¨é¦¬å»æ‰¾ä¸€æ¢ç¾éº—çš„æºªæµé™„è¿‘çš„å¥½åœ°æ–¹ã€‚é¨é¦¬åˆå¿«åˆè¼•é¬†ï¼"
  },
  {
    en: "A thin wizard and a short turtle came too. The wizard brought a tent, an ax, and binoculars. The turtle brought a soft pillow and a basket of tangerines. \"This pillow is soft and light, but look at that rock â€” it is hard and heavy!\" said the turtle.",
    zh: "ä¸€ä½ç˜¦ç˜¦çš„å·«å¸«å’Œä¸€éš»çŸ®çŸ®çš„çƒé¾œä¹Ÿä¾†äº†ã€‚å·«å¸«å¸¶äº†å¸³ç¯·ã€æ–§é ­å’Œæœ›é é¡ã€‚çƒé¾œå¸¶äº†ä¸€é¡†æŸ”è»Ÿçš„æ•é ­å’Œä¸€ç±ƒæŸ‘æ©˜ã€‚ã€Œé€™é¡†æ•é ­åˆè»Ÿåˆè¼•ï¼Œä½†ä½ çœ‹é‚£å¡ŠçŸ³é ­â€”â€”åˆç¡¬åˆé‡ï¼ã€çƒé¾œèªªã€‚"
  },
  {
    en: "They set up the tent near the stream. The wizard used the ax to cut wood for a campfire. The smoke went up high into the sky. \"Let me make a barbecue!\" said the king. He brought homemade bread and enough food for everyone. \"Please wait â€” I still need to peel the tangerines!\" said the turtle.",
    zh: "ä»–å€‘åœ¨æºªé‚Šæ­èµ·å¸³ç¯·ã€‚å·«å¸«ç”¨æ–§é ­ç æœ¨é ­ç”Ÿç‡Ÿç«ã€‚ç…™éœ§é«˜é«˜å‡èµ·ã€‚ã€Œè®“æˆ‘ä¾†çƒ¤è‚‰ï¼ã€åœ‹ç‹èªªã€‚ä»–å¸¶äº†è‡ªè£½éºµåŒ…å’Œè¶³å¤ æ‰€æœ‰äººåƒçš„é£Ÿç‰©ã€‚ã€Œè«‹ç­‰ä¸€ä¸‹â€”â€”æˆ‘é‚„åœ¨å‰æŸ‘æ©˜çš®ï¼ã€çƒé¾œèªªã€‚"
  },
  {
    en: "A fat kangaroo came with a butterfly net and an insect box. She played a trick on the turtle. She hid his lollipop in the forest! The turtle was in big trouble. \"Don't worry,\" said the wizard. \"Let me help!\" Without thinking, the wizard made a mistake. He used magic and the lollipop became very heavy!",
    zh: "ä¸€éš»èƒ–èƒ–çš„è¢‹é¼ å¸¶è‘—æ•èŸ²ç¶²å’Œæ˜†èŸ²ç®±ä¾†äº†ã€‚å¥¹å°çƒé¾œæƒ¡ä½œåŠ‡ï¼ŒæŠŠä»–çš„æ£’æ£’ç³–è—åœ¨æ£®æ—è£¡ï¼çƒé¾œé‡åˆ°å¤§éº»ç…©ã€‚ã€Œåˆ¥æ“”å¿ƒï¼Œã€å·«å¸«èªªã€‚ã€Œè®“æˆ‘ä¾†å¹«å¿™ï¼ã€ä¸å‡æ€ç´¢ï¼Œå·«å¸«çŠ¯äº†ä¸€å€‹éŒ¯ã€‚ä»–ç”¨é­”æ³•è®“æ£’æ£’ç³–è®Šå¾—è¶…ç´šé‡ï¼"
  },
  {
    en: "They went fishing near the stream. The king tried to catch a big fish, but it was not easy. \"Try again!\" the kangaroo said. The king tried and tried. At last, he caught one! \"The magic present was a big surprise!\" the wizard joked. They all had a big smile.",
    zh: "ä»–å€‘åœ¨æºªé‚Šé‡£é­šã€‚åœ‹ç‹è©¦è‘—æŠ“ä¸€æ¢å¤§é­šï¼Œä½†ä¸å¤ªå®¹æ˜“ã€‚ã€Œå†è©¦ä¸€æ¬¡ï¼ã€è¢‹é¼ èªªã€‚åœ‹ç‹ä¸€è©¦å†è©¦ã€‚çµ‚æ–¼ï¼Œä»–æŠ“åˆ°ä¸€æ¢ï¼ã€Œé€™å€‹ç¥å¥‡çš„ç¦®ç‰©çœŸæ˜¯å¤§é©šå–œï¼ã€å·«å¸«é–‹ç©ç¬‘ã€‚å¤§å®¶éƒ½éœ²å‡ºäº†å¤§å¤§çš„å¾®ç¬‘ã€‚"
  },
  {
    en: "In the evening, they played games near the campfire. They played basketball and badminton. The king found a newspaper and saw a picture of his castle on the wall. \"I wish we could have a birthday party here!\" he said. The wizard told a funny story. \"He picked a story without a point!\" the kangaroo laughed.",
    zh: "å‚æ™šï¼Œä»–å€‘åœ¨ç‡Ÿç«æ—ç©éŠæˆ²ã€‚ä»–å€‘æ‰“ç±ƒçƒå’Œç¾½æ¯›çƒã€‚åœ‹ç‹çœ‹åˆ°ä¸€ä»½å ±ç´™ï¼Œä¸Šé¢æœ‰ä¸€å¼µä»–åŸå ¡çš„ç…§ç‰‡æ›åœ¨ç‰†ä¸Šã€‚ã€Œæˆ‘çœŸå¸Œæœ›æˆ‘å€‘èƒ½åœ¨é€™è£¡è¾¦ç”Ÿæ—¥æ´¾å°ï¼ã€ä»–èªªã€‚å·«å¸«è¬›äº†ä¸€å€‹å¥½ç¬‘çš„æ•…äº‹ã€‚ã€Œä»–æŒ‘äº†ä¸€å€‹æ²’æœ‰é‡é»çš„æ•…äº‹ï¼ã€è¢‹é¼ å¤§ç¬‘ã€‚"
  },
  {
    en: "Before breakfast the next morning, the king said, \"Always brush your teeth! Keep your teeth clean and healthy!\" The turtle showed one dirty tooth. \"May I buy a new brush from the shop?\" he asked. \"You may,\" said the king. \"A clean tooth is a happy tooth!\"",
    zh: "éš”å¤©æ—©é¤å‰ï¼Œåœ‹ç‹èªªï¼šã€Œä¸€å®šè¦åˆ·ç‰™ï¼ä¿æŒç‰™é½’ä¹¾æ·¨åˆå¥åº·ï¼ã€çƒé¾œéœ²å‡ºä¸€é¡†é«’å…®å…®çš„ç‰™é½’ã€‚ã€Œæˆ‘å¯ä»¥å»å•†åº—è²·ä¸€æŠŠæ–°åˆ·å­å—ï¼Ÿã€ä»–å•ã€‚ã€Œå¯ä»¥ï¼Œã€åœ‹ç‹èªªã€‚ã€Œä¹¾æ·¨çš„ç‰™é½’å°±æ˜¯å¿«æ¨‚çš„ç‰™é½’ï¼ã€"
  },
  {
    en: "\"We still have homework and a test tomorrow,\" said the turtle. \"We need to study!\" They walked back to the castle. The king said, \"I will always love all kinds of friends! This was the best summer plan!\" Everyone smiled and hugged. They rode the horses home fast. What a wonderful camping trip!",
    zh: "ã€Œæˆ‘å€‘é‚„æœ‰åŠŸèª²å’Œæ˜å¤©çš„è€ƒè©¦ï¼Œã€çƒé¾œèªªã€‚ã€Œæˆ‘å€‘å¾—å”¸æ›¸äº†ï¼ã€ä»–å€‘èµ°å›åŸå ¡ã€‚åœ‹ç‹èªªï¼šã€Œæˆ‘æœƒæ°¸é æ„›æ‰€æœ‰çš„æœ‹å‹ï¼é€™æ˜¯æœ€æ£’çš„å¤æ—¥è¨ˆç•«ï¼ã€å¤§å®¶å¾®ç¬‘æ“æŠ±ã€‚ä»–å€‘å¿«é€Ÿé¨é¦¬å›å®¶ã€‚å¤šéº¼ç¾å¥½çš„éœ²ç‡Ÿä¹‹æ—…ï¼"
  }
];

/* ============================================================
   QUIZ  (10 questions)
   ============================================================ */
var QUIZ = [
  {
    q: "Where did the king want to go camping?",
    opts: ["Near a shop","In the forest","At a castle","In the garden"],
    ans: 1
  },
  {
    q: "What did the turtle bring for the trip?",
    opts: ["A tent and an ax","Binoculars and a newspaper","A soft pillow and tangerines","A butterfly net and an insect box"],
    ans: 2
  },
  {
    q: "What was hard and heavy?",
    opts: ["The pillow","The tangerine","The tent","The rock"],
    ans: 3
  },
  {
    q: "What did the wizard use to cut wood for the campfire?",
    opts: ["A rock","An ax","A butterfly net","A brush"],
    ans: 1
  },
  {
    q: "What trick did the kangaroo play on the turtle?",
    opts: ["She hid his lollipop in the forest","She ate his breakfast","She broke his brush","She took his pillow"],
    ans: 0
  },
  {
    q: "What mistake did the wizard make?",
    opts: ["He burned the food","He broke the tent","He made the lollipop very heavy","He lost the binoculars"],
    ans: 2
  },
  {
    q: "What did the king catch near the stream?",
    opts: ["A butterfly","A turtle","A rock","A fish"],
    ans: 3
  },
  {
    q: "What did the king find in the newspaper?",
    opts: ["A funny story","A picture of his castle","A plan for homework","A game about camping"],
    ans: 1
  },
  {
    q: "What should you do before breakfast?",
    opts: ["Play basketball","Go camping near a stream","Do your homework","Brush your teeth"],
    ans: 3
  },
  {
    q: "Why did they need to go back to the castle?",
    opts: ["They were hungry","They still had homework and a test","The campfire went out","It started to rain"],
    ans: 1
  }
];

/* ============================================================
   STATE
   ============================================================ */
var difficulty = 'medium';
var speechRate = 0.85;
var blanksData = {};
var totalBlanks = 0;
var solvedBlanks = 0;
var quizAnswers = {};
var quizSubmitted = false;
var quizListenModes = {};
var activePopup = null;
var activeReadBtn = null;
var activeSentenceEl = null;

/* ============================================================
   SPEECH SYNTHESIS
   ============================================================ */
function stopAll() {
  try { speechSynthesis.cancel(); } catch(e) {}
  var els = document.querySelectorAll('.speaking');
  for (var i = 0; i < els.length; i++) els[i].classList.remove('speaking');
  var hls = document.querySelectorAll('.highlight');
  for (var i = 0; i < hls.length; i++) hls[i].classList.remove('highlight');
  var ps = document.querySelectorAll('.playing-sentence');
  for (var i = 0; i < ps.length; i++) ps[i].classList.remove('playing-sentence');
  activeSentenceEl = null;
  if (activeReadBtn) {
    activeReadBtn.textContent = 'ğŸ”Š æœ—è®€';
    activeReadBtn.className = 'btn btn-read';
    activeReadBtn = null;
  }
}

function speak(text, onEnd) {
  if (!window.speechSynthesis) { if (onEnd) onEnd(); return; }
  var u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = speechRate;
  var voices = speechSynthesis.getVoices();
  for (var i = 0; i < voices.length; i++) {
    if (voices[i].lang && voices[i].lang.indexOf('en') === 0) { u.voice = voices[i]; break; }
  }
  u.onend = function() { if (onEnd) onEnd(); };
  u.onerror = function() { if (onEnd) onEnd(); };
  speechSynthesis.speak(u);
}

/* ============================================================
   UTILITY
   ============================================================ */
function shuffle(arr) {
  var a = arr.slice();
  for (var i = a.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var t = a[i]; a[i] = a[j]; a[j] = t;
  }
  return a;
}

function isWordChar(ch) {
  if (!ch) return false;
  var c = ch.charCodeAt(0);
  return (c >= 65 && c <= 90) || (c >= 97 && c <= 122) || ch === '-' || ch === '\'';
}

function splitSentences(text) {
  var result = [];
  var re = /[^.!?"]*[.!?"]+['"]?\s*/g;
  var m;
  while ((m = re.exec(text)) !== null) {
    var s = m[0].trim();
    if (s) result.push(s);
  }
  if (result.length === 0 && text.trim()) result.push(text.trim());
  return result;
}

/* ============================================================
   TEXT PARSER
   ============================================================ */
function parseText(text) {
  var parts = [];
  var i = 0;
  while (i < text.length) {
    var matched = false;
    for (var vi = 0; vi < VOCAB.length; vi++) {
      var vw = VOCAB[vi][0];
      var vlen = vw.length;
      if (i + vlen > text.length) continue;
      var seg = text.slice(i, i + vlen);
      if (seg.toLowerCase() !== vw.toLowerCase()) continue;
      var before = i > 0 ? text[i - 1] : '';
      var after = (i + vlen < text.length) ? text[i + vlen] : '';
      if (isWordChar(before) || isWordChar(after)) continue;
      parts.push({ type: 'w', v: seg, word: vw, zh: VOCAB[vi][1] });
      i += vlen;
      matched = true;
      break;
    }
    if (!matched) {
      if (parts.length && parts[parts.length - 1].type === 't') {
        parts[parts.length - 1].v += text[i];
      } else {
        parts.push({ type: 't', v: text[i] });
      }
      i++;
    }
  }
  return parts;
}

/* ============================================================
   GENERATE OPTIONS
   ============================================================ */
function generateOptions(correctWord) {
  var opts = [correctWord];
  var pool = [];
  for (var i = 0; i < VOCAB.length; i++) {
    if (VOCAB[i][0].toLowerCase() !== correctWord.toLowerCase()) {
      pool.push(VOCAB[i][0]);
    }
  }
  pool = shuffle(pool);
  for (var i = 0; i < pool.length && opts.length < 4; i++) {
    opts.push(pool[i]);
  }
  return shuffle(opts);
}

/* ============================================================
   CLOSE POPUPS
   ============================================================ */
function closeAllPopups() {
  var popups = document.querySelectorAll('.blank-opts-popup.show');
  for (var i = 0; i < popups.length; i++) popups[i].classList.remove('show');
  var ps = document.querySelectorAll('.playing-sentence');
  for (var i = 0; i < ps.length; i++) ps[i].classList.remove('playing-sentence');
  activePopup = null;
  activeSentenceEl = null;
}

/* ============================================================
   PROGRESS BAR
   ============================================================ */
function updateProgress() {
  var bar = document.getElementById('prog-bar');
  var txt = document.getElementById('prog-text');
  var pct = totalBlanks > 0 ? Math.round((solvedBlanks / totalBlanks) * 100) : 0;
  bar.style.width = Math.max(pct, 8) + '%';
  txt.textContent = solvedBlanks + ' / ' + totalBlanks;
  if (solvedBlanks === totalBlanks && totalBlanks > 0) {
    bar.parentElement.style.animation = 'celebrate .6s ease';
    setTimeout(function() { bar.parentElement.style.animation = ''; }, 700);
  }
}

/* ============================================================
   BUILD STORY  (blank plays FULL SENTENCE)
   ============================================================ */
function buildStory() {
  var cont = document.getElementById('story');
  cont.innerHTML = '';
  blanksData = {};
  totalBlanks = 0;
  solvedBlanks = 0;
  var blankIdCounter = 0;
  var blankRatio = { easy: 0.2, medium: 0.4, hard: 0.6 }[difficulty];

  for (var pi = 0; pi < PARAS.length; pi++) {
    var card = document.createElement('div');
    card.className = 'pcard';
    var enP = document.createElement('p');
    enP.className = 'para-en';
    enP.id = 'en' + pi;

    var sentences = splitSentences(PARAS[pi].en);
    var paraVocabPositions = [];

    for (var si = 0; si < sentences.length; si++) {
      var parts = parseText(sentences[si]);
      for (var k = 0; k < parts.length; k++) {
        if (parts[k].type === 'w') {
          paraVocabPositions.push({
            si: si, ki: k,
            word: parts[k].word, v: parts[k].v, zh: parts[k].zh,
            sentence: sentences[si]
          });
        }
      }
    }

    var numBlanks = Math.max(1, Math.round(paraVocabPositions.length * blankRatio));
    var shuffledPositions = shuffle(paraVocabPositions.map(function(_, idx) { return idx; }));
    var blankSet = {};
    for (var b = 0; b < numBlanks && b < shuffledPositions.length; b++) {
      blankSet[shuffledPositions[b]] = true;
    }

    for (var si = 0; si < sentences.length; si++) {
      var sspan = document.createElement('span');
      sspan.className = 'ssen';
      sspan.dataset.paraIdx = pi;
      sspan.dataset.sentIdx = si;

      var parts = parseText(sentences[si]);
      for (var k = 0; k < parts.length; k++) {
        var pt = parts[k];
        if (pt.type === 't') {
          sspan.appendChild(document.createTextNode(pt.v));
        } else {
          var vocabIdx = -1;
          for (var q = 0; q < paraVocabPositions.length; q++) {
            if (paraVocabPositions[q].si === si && paraVocabPositions[q].ki === k) {
              vocabIdx = q; break;
            }
          }

          if (vocabIdx >= 0 && blankSet[vocabIdx]) {
            var bid = 'blank-' + blankIdCounter++;
            totalBlanks++;
            blanksData[bid] = {
              word: pt.word, display: pt.v, zh: pt.zh,
              solved: false, sentence: sentences[si]
            };
            var wrap = document.createElement('span');
            wrap.className = 'blank-wrap';
            wrap.id = bid;

            var speakerBtn = document.createElement('button');
            speakerBtn.className = 'blank-speaker';
            speakerBtn.innerHTML = '____&nbsp;ğŸ”Š';
            speakerBtn.title = 'è½æ•´å¥è©±ï¼Œæ‰¾å‡ºç©ºæ ¼çš„å–®å­—';
            (function(blankId, sentenceText, ssEl) {
              speakerBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                stopAll();
                closeAllPopups();
                ssEl.classList.add('playing-sentence');
                activeSentenceEl = ssEl;
                speak(sentenceText, function() {});
                var popup = document.getElementById(blankId + '-opts');
                if (popup) { popup.classList.add('show'); activePopup = popup; }
              });
            })(bid, sentences[si], sspan);
            wrap.appendChild(speakerBtn);

            var popup = document.createElement('div');
            popup.className = 'blank-opts-popup';
            popup.id = bid + '-opts';
            var hintDiv = document.createElement('div');
            hintDiv.className = 'blank-hint';
            hintDiv.textContent = 'ğŸ‘‚ å“ªå€‹å–®å­—ä¸è¦‹äº†ï¼Ÿ';
            popup.appendChild(hintDiv);
            var options = generateOptions(pt.word);
            for (var oi = 0; oi < options.length; oi++) {
              var optBtn = document.createElement('button');
              optBtn.className = 'blank-opt-btn';
              optBtn.textContent = options[oi];
              (function(blankId, selected, btn) {
                optBtn.addEventListener('click', function(e) {
                  e.stopPropagation();
                  checkBlankAnswer(blankId, selected, btn);
                });
              })(bid, options[oi], optBtn);
              popup.appendChild(optBtn);
            }
            wrap.appendChild(popup);
            sspan.appendChild(wrap);
          } else {
            var sp = document.createElement('span');
            sp.className = 'vw';
            sp.textContent = pt.v;
            sp.title = pt.word + ' = ' + pt.zh;
            (function(el, word) {
              el.addEventListener('click', function(e) {
                e.stopPropagation();
                stopAll(); closeAllPopups();
                el.classList.add('speaking');
                speak(word, function() { el.classList.remove('speaking'); });
              });
            })(sp, pt.word);
            sspan.appendChild(sp);
          }
        }
      }
      enP.appendChild(sspan);
      if (si < sentences.length - 1) enP.appendChild(document.createTextNode(' '));
    }
    card.appendChild(enP);

    var zhP = document.createElement('div');
    zhP.className = 'para-zh';
    zhP.textContent = PARAS[pi].zh;
    card.appendChild(zhP);

    var ctrl = document.createElement('div');
    ctrl.className = 'pctrl';

    (function(zhDiv) {
      var bz = document.createElement('button');
      bz.className = 'btn btn-zh';
      bz.textContent = 'ğŸ”¤ ä¸­æ–‡ç¿»è­¯';
      bz.addEventListener('click', function() {
        if (zhDiv.style.display === 'block') {
          zhDiv.style.display = 'none'; bz.textContent = 'ğŸ”¤ ä¸­æ–‡ç¿»è­¯';
        } else {
          zhDiv.style.display = 'block'; bz.textContent = 'ğŸ”¤ éš±è—ä¸­æ–‡';
        }
      });
      ctrl.appendChild(bz);
    })(zhP);

    (function(idx, enEl) {
      var br = document.createElement('button');
      br.className = 'btn btn-read';
      br.textContent = 'ğŸ”Š æœ—è®€';
      br.addEventListener('click', function() {
        if (activeReadBtn === br) { stopAll(); return; }
        stopAll(); closeAllPopups();
        activeReadBtn = br;
        br.textContent = 'â¹ åœæ­¢'; br.className = 'btn btn-stop';
        var spans = enEl.querySelectorAll('.ssen');
        if (spans.length === 0) {
          speak(PARAS[idx].en, function() {
            br.textContent = 'ğŸ”Š æœ—è®€'; br.className = 'btn btn-read'; activeReadBtn = null;
          });
          return;
        }
        var si = 0;
        function readNext() {
          if (si >= spans.length || activeReadBtn !== br) {
            for (var j = 0; j < spans.length; j++) spans[j].classList.remove('highlight');
            if (activeReadBtn === br) {
              br.textContent = 'ğŸ”Š æœ—è®€'; br.className = 'btn btn-read'; activeReadBtn = null;
            }
            return;
          }
          for (var j = 0; j < spans.length; j++) spans[j].classList.remove('highlight');
          spans[si].classList.add('highlight');
          var fullSentence = splitSentences(PARAS[idx].en)[si] || '';
          speak(fullSentence, function() { si++; readNext(); });
        }
        readNext();
      });
      ctrl.appendChild(br);
    })(pi, enP);

    card.appendChild(ctrl);
    cont.appendChild(card);
  }
  updateProgress();
}

/* ============================================================
   CHECK BLANK
   ============================================================ */
function checkBlankAnswer(blankId, selected, btnEl) {
  var data = blanksData[blankId];
  if (!data || data.solved) return;
  if (selected.toLowerCase() === data.word.toLowerCase()) {
    data.solved = true;
    solvedBlanks++;
    closeAllPopups();
    var wrap = document.getElementById(blankId);
    var solved = document.createElement('span');
    solved.className = 'blank-solved';
    solved.textContent = data.display;
    solved.title = data.word + ' = ' + data.zh;
    (function(el, word) {
      el.addEventListener('click', function(e) {
        e.stopPropagation(); stopAll();
        el.classList.add('speaking');
        speak(word, function() { el.classList.remove('speaking'); });
      });
    })(solved, data.word);
    wrap.parentNode.replaceChild(solved, wrap);
    updateProgress();
    stopAll();
    speak(data.word);
  } else {
    btnEl.classList.add('wrong');
  }
}

/* ============================================================
   WORD CHIPS
   ============================================================ */
function buildChips() {
  var cont = document.getElementById('chips');
  cont.innerHTML = '';
  var allWords = VOCAB.concat(EXTRA_CHIPS);
  for (var i = 0; i < allWords.length; i++) {
    (function(en, zh) {
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = en + ' ' + zh;
      chip.title = en + ' = ' + zh;
      chip.addEventListener('click', function() {
        stopAll(); closeAllPopups();
        chip.classList.add('speaking');
        speak(en, function() { chip.classList.remove('speaking'); });
      });
      cont.appendChild(chip);
    })(allWords[i][0], allWords[i][1]);
  }
}

/* ============================================================
   BUILD QUIZ
   ============================================================ */
function buildQuiz() {
  var cont = document.getElementById('qcont');
  cont.innerHTML = '';
  quizAnswers = {};
  quizSubmitted = false;
  document.getElementById('sub-btn').disabled = false;
  document.getElementById('scoreboard').classList.remove('show');

  var listenRatio = { easy: 0.2, medium: 0.4, hard: 0.6 }[difficulty];
  var numListen = Math.max(1, Math.round(QUIZ.length * listenRatio));
  var indices = [];
  for (var i = 0; i < QUIZ.length; i++) indices.push(i);
  var shuffledIdx = shuffle(indices);
  quizListenModes = {};
  for (var i = 0; i < numListen && i < shuffledIdx.length; i++) {
    quizListenModes[shuffledIdx[i]] = Math.random() < 0.5 ? 'stem' : 'options';
  }

  for (var qi = 0; qi < QUIZ.length; qi++) {
    var q = QUIZ[qi];
    var listenMode = quizListenModes[qi] || 'none';
    var card = document.createElement('div');
    card.className = 'qcard'; card.id = 'qcard' + qi;

    var hdr = document.createElement('div');
    hdr.className = 'qhdr';
    var qnum = document.createElement('span');
    qnum.className = 'qnum'; qnum.textContent = (qi + 1);
    hdr.appendChild(qnum);

    var qtxt = document.createElement('span');
    qtxt.className = 'qtxt'; qtxt.id = 'qtxt' + qi;
    if (listenMode === 'stem') {
      var hl = document.createElement('span');
      hl.className = 'qtxt-hidden';
      hl.textContent = 'ğŸ‘‚ Click ğŸ”Š to listen to the question';
      qtxt.appendChild(hl);
      qtxt.dataset.fullText = q.q;
    } else {
      qtxt.textContent = q.q;
    }
    hdr.appendChild(qtxt);

    var spkBtn = document.createElement('button');
    spkBtn.className = 'qspk'; spkBtn.textContent = 'ğŸ”Š'; spkBtn.title = 'è½é¡Œç›®';
    (function(text, btn) {
      btn.addEventListener('click', function() {
        stopAll(); closeAllPopups();
        btn.classList.add('speaking');
        speak(text, function() { btn.classList.remove('speaking'); });
      });
    })(q.q, spkBtn);
    hdr.appendChild(spkBtn);
    card.appendChild(hdr);

    var grid = document.createElement('div');
    grid.className = 'ogrid';
    for (var oi = 0; oi < q.opts.length; oi++) {
      (function(qIdx, optIdx, optText, myGrid, mode) {
        var ob = document.createElement('button');
        ob.className = 'obtn'; ob.id = 'obtn-' + qIdx + '-' + optIdx;
        if (mode === 'options') {
          var os = document.createElement('span');
          os.className = 'opt-speaker'; os.textContent = 'ğŸ”Š';
          ob.appendChild(os);
          ob.appendChild(document.createTextNode(' è½é¸é … ' + String.fromCharCode(65 + optIdx)));
          ob.dataset.fullText = optText;
          ob.addEventListener('mouseenter', function() {
            if (quizSubmitted) return; stopAll(); speak(optText);
          });
        } else {
          ob.textContent = String.fromCharCode(65 + optIdx) + '. ' + optText;
        }
        ob.addEventListener('click', function() {
          if (quizSubmitted) return;
          var sibs = myGrid.querySelectorAll('.obtn');
          for (var s = 0; s < sibs.length; s++) sibs[s].classList.remove('sel');
          ob.classList.add('sel');
          quizAnswers[qIdx] = optIdx;
          if (mode === 'options') { stopAll(); speak(optText); }
        });
        myGrid.appendChild(ob);
      })(qi, oi, q.opts[oi], grid, listenMode);
    }
    card.appendChild(grid);

    var fb = document.createElement('div');
    fb.className = 'qfb'; fb.id = 'qfb' + qi;
    card.appendChild(fb);
    cont.appendChild(card);
  }
}

/* ============================================================
   SUBMIT QUIZ
   ============================================================ */
function submitQuiz() {
  if (quizSubmitted) return;
  var total = QUIZ.length;
  if (Object.keys(quizAnswers).length < total) {
    alert('è«‹å…ˆå›ç­”æ‰€æœ‰ ' + total + ' é¡Œå–”ï¼\nPlease answer all ' + total + ' questions!');
    return;
  }
  quizSubmitted = true;
  document.getElementById('sub-btn').disabled = true;
  var score = 0;

  for (var qi = 0; qi < QUIZ.length; qi++) {
    var q = QUIZ[qi];
    var card = document.getElementById('qcard' + qi);
    var fb = document.getElementById('qfb' + qi);
    var userAns = quizAnswers[qi];
    var correctIdx = q.ans;
    var isCorrect = (userAns === correctIdx);

    var qtxt = document.getElementById('qtxt' + qi);
    if (qtxt.dataset.fullText) qtxt.textContent = q.q;

    if (isCorrect) {
      score++;
      card.classList.add('qok');
      fb.className = 'qfb fbok';
      fb.textContent = 'âœ… Correct! æ­£ç¢ºï¼';
    } else {
      card.classList.add('qno');
      fb.className = 'qfb fbno';
      fb.textContent = 'âŒ Answer: ' + String.fromCharCode(65 + correctIdx) + '. ' + q.opts[correctIdx];
    }
    fb.style.display = 'block';

    var btns = card.querySelectorAll('.obtn');
    for (var bi = 0; bi < btns.length; bi++) {
      btns[bi].disabled = true;
      if (btns[bi].dataset.fullText) btns[bi].textContent = String.fromCharCode(65 + bi) + '. ' + q.opts[bi];
      if (bi === correctIdx) btns[bi].classList.add('ok');
      else if (bi === userAns && !isCorrect) btns[bi].classList.add('no');
    }
  }

  var sb = document.getElementById('scoreboard');
  document.getElementById('score-big').textContent = score + ' / ' + total;
  var msg = '';
  if (score === total) msg = 'ğŸ‰ æ»¿åˆ†ï¼å¤ªå²å®³äº†ï¼Perfect score!';
  else if (score >= 8) msg = 'ğŸ‘ éå¸¸æ£’ï¼Almost perfect!';
  else if (score >= 6) msg = 'ğŸ˜Š ä¸éŒ¯å–”ï¼Good job!';
  else if (score >= 4) msg = 'ğŸ’ª ç¹¼çºŒåŠ æ²¹ï¼Keep trying!';
  else msg = 'ğŸ“– å†ä»”ç´°è®€ä¸€æ¬¡æ•…äº‹å§ï¼Read the story again!';
  document.getElementById('score-msg').textContent = msg;
  sb.classList.add('show');
  sb.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ============================================================
   REBUILD / DIFFICULTY / INIT
   ============================================================ */
function rebuildAll() { stopAll(); closeAllPopups(); buildStory(); buildQuiz(); }

function setDifficulty(diff) {
  difficulty = diff;
  var btns = document.querySelectorAll('.diff-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = 'diff-btn';
    if (btns[i].dataset.diff === diff) btns[i].classList.add('active-' + diff);
  }
  rebuildAll();
}

document.addEventListener('DOMContentLoaded', function() {
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = function() {};
  }

  var slider = document.getElementById('speed-slider');
  var sval = document.getElementById('speed-val');
  slider.addEventListener('input', function() {
    speechRate = parseFloat(slider.value);
    sval.textContent = speechRate.toFixed(2) + 'x';
  });

  var diffBtns = document.querySelectorAll('.diff-btn');
  for (var i = 0; i < diffBtns.length; i++) {
    (function(btn) {
      btn.addEventListener('click', function() { setDifficulty(btn.dataset.diff); });
    })(diffBtns[i]);
  }

  document.addEventListener('click', function(e) {
    if (activePopup && !e.target.closest('.blank-wrap')) closeAllPopups();
  });

  document.getElementById('go-quiz-btn').addEventListener('click', function() {
    document.getElementById('quiz-anchor').scrollIntoView({ behavior: 'smooth' });
  });
  document.getElementById('sub-btn').addEventListener('click', submitQuiz);
  document.getElementById('retry-btn').addEventListener('click', function() {
    buildQuiz();
    document.getElementById('quiz-anchor').scrollIntoView({ behavior: 'smooth' });
  });

  buildChips();
  setDifficulty('medium');
});
</script>
</body>
</html>